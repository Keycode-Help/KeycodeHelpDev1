# Admin Registration Code System

## Overview

The Admin Registration Code System provides a secure way for new administrators to register for accounts. It requires a valid registration code that can only be generated by existing super admins.

## How It Works

### 1. Code Generation

- **Super Admins** can generate registration codes from the Super Admin Dashboard
- Codes are 8-character alphanumeric strings (e.g., "ABC12345")
- Codes expire after 24 hours
- Each code is unique and tied to a specific email address

### 2. Code Storage

- Registration codes are stored in the `admin_registration_code` database table
- Codes are no longer stored in memory (fixed reliability issue)
- Database provides persistence across application restarts
- Automatic cleanup of expired codes every hour

### 3. Registration Process

1. **Request Code**: User fills out basic info and requests a registration code
2. **Code Sent**: System sends code via email to the applicant
3. **Code Validation**: User enters the code and can validate it before submission
4. **Account Creation**: If code is valid, admin account is created (unapproved)
5. **Approval Required**: Super admin must approve the account before it becomes active

## Database Schema

### admin_registration_code Table

```sql
CREATE TABLE admin_registration_code (
    id BIGSERIAL PRIMARY KEY,
    code VARCHAR(8) UNIQUE NOT NULL,
    email VARCHAR(255) NOT NULL,
    applicant_name VARCHAR(255) NOT NULL,
    expiry_time TIMESTAMP NOT NULL,
    is_used BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    used_at TIMESTAMP,
    used_by_email VARCHAR(255)
);
```

## API Endpoints

### Request Registration Code

```
POST /admin-registration-code/request
Content-Type: application/json
Authorization: Required (Admin or Super Admin)

{
  "email": "user@company.com",
  "firstName": "John",
  "lastName": "Doe"
}
```

### Validate Registration Code

```
POST /admin-registration-code/validate
Content-Type: application/json
Authorization: Required (Admin or Super Admin)

{
  "email": "user@company.com",
  "code": "ABC12345"
}
```

### Admin Registration

```
POST /auth/admin-register
Content-Type: multipart/form-data

fname: John
lname: Doe
email: user@company.com
phone: +1234567890
password: securepassword
company: Company Name
adminCode: ABC12345
```

### Debug Endpoints

```
GET /admin-registration-code/active/{email} - Get active codes for an email
GET /admin-registration-code/unused - Get all unused codes
GET /admin-registration-code/health - Health check
```

## Security Features

### Code Validation

- Codes are single-use (marked as used after validation)
- Codes expire after 24 hours
- Codes are tied to specific email addresses
- Secure random generation using `SecureRandom`

### Access Control

- Only authenticated admins/super admins can generate codes
- Only authenticated admins/super admins can validate codes
- Registration endpoint is public (no authentication required)

### Email Security

- Codes are sent via secure SMTP (Brevo)
- No sensitive information in email content
- Clear expiration information

## Frontend Integration

### AdminRegister Component

- **Request Code Button**: Generates and sends registration code
- **Validate Code Button**: Validates code before form submission
- **Real-time Feedback**: Shows success/error messages
- **Form Validation**: Ensures all required fields are filled

### User Experience

1. User fills out basic information
2. Clicks "Request Code" to receive email
3. Enters received code in the form
4. Optionally validates code before submission
5. Submits form to create account

## Error Handling

### Common Error Scenarios

- **Invalid Code**: Code doesn't exist or has expired
- **Used Code**: Code has already been used
- **Email Mismatch**: Code was sent to different email
- **Expired Code**: Code is older than 24 hours

### Error Messages

- Clear, user-friendly error messages
- Specific validation feedback
- Helpful guidance for resolution

## Monitoring and Maintenance

### Automatic Cleanup

- Expired codes are automatically removed every hour
- Database indexes optimize query performance
- Logging for debugging and monitoring

### Debug Tools

- Endpoints to view active/unused codes
- Health check endpoint
- Comprehensive logging throughout the process

## Testing

### Unit Tests

- `AdminRegistrationCodeServiceTest` covers core functionality
- Tests code generation, validation, and expiry
- Mocked dependencies for isolated testing

### Integration Tests

- End-to-end testing of the registration flow
- Database integration testing
- Email service testing

## Configuration

### Environment Variables

```bash
# Brevo SMTP Configuration
BREVO_USERNAME=your-smtp-username
BREVO_API_KEY=your-smtp-password

# Database Configuration
SPRING_DATASOURCE_URL=jdbc:postgresql://...
SPRING_DATASOURCE_USERNAME=your-db-username
SPRING_DATASOURCE_PASSWORD=your-db-password
```

### Code Settings

- **Code Length**: 8 characters (configurable)
- **Expiry Time**: 24 hours (configurable)
- **Cleanup Interval**: 1 hour (configurable)

## Troubleshooting

### Common Issues

1. **Codes not being sent**: Check Brevo SMTP configuration
2. **Codes not validating**: Check database connection and table creation
3. **Codes expiring too quickly**: Verify system time and expiry logic
4. **Email delivery issues**: Check spam folders and SMTP settings

### Debug Steps

1. Check application logs for error messages
2. Verify database table exists and has correct schema
3. Test SMTP connection with Brevo
4. Use debug endpoints to inspect code status

## Future Enhancements

### Planned Features

- **Code Resend**: Allow users to request new codes
- **Bulk Code Generation**: Generate multiple codes at once
- **Code Analytics**: Track code usage and success rates
- **Advanced Expiry**: Configurable expiry times per code type

### Scalability Improvements

- **Redis Caching**: Cache frequently accessed codes
- **Async Processing**: Background email sending
- **Rate Limiting**: Prevent abuse of code generation
- **Audit Logging**: Track all code-related activities
